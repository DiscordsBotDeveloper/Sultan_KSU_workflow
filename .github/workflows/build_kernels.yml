name: Sultan

permissions:
  contents: write
  actions: write

on:
  workflow_call:
  workflow_dispatch:
  pull_request:
  push:
    paths-ignore:
      - 'README.md'
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        susfs: [false, true]
        build:
#          - type: Normal
#            ksu: false
#            exclude: susfs
#            ak3_suffix: ""
#          - type: KSU
#            ksu: true
#            repo: "tiann/KernelSU"
#            folder: "KernelSU"
#            branch: "main"
#            kernel_patches: "../james_patches/next/next_hooks.patch"
#            extra_configs: "CONFIG_KPROBES=n"
#            susfs_ksu_patches: "../susfs/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch"
#            ak3_suffix: "_KSU"
          - type: KSUN
            ksu: true
            repo: "KernelSU-Next/KernelSU-Next"
            folder: "KernelSU-Next"
            branch: "next"
            exclude: susfs
            susfs_repo: "pershoot/KernelSU-Next"
            susfs_branch: "next-susfs"
            ksu_patches: "KSUN/WildJames-Manager.patch"
            kernel_patches: "../james_patches/sultan/syscall_hooks.patch"
            extra_configs: "CONFIG_KSU_KPROBES_HOOK=n"
            ak3_suffix: "_KSUNext"
          - type: RKSU
            ksu: true
            repo: "rsuntk/KernelSU"
            folder: "KernelSU"
            branch: "main"
            susfs_branch: "susfs-rksu-master"
            susfsless_kernel_patches: "../james_patches/sultan/syscall_hooks.patch sultan/reboot-hook.patch"
            extra_configs: "CONFIG_KSU_MANUAL_HOOK=y"
            ak3_suffix: "_RKSU"
          - type: SukiSU
            ksu: true
            repo: "SukiSU-Ultra/SukiSU-Ultra"
            folder: "KernelSU"
            branch: "nongki"
            susfs_branch: "susfs-main"
            susfsless_kernel_patches: "../james_patches/sultan/syscall_hooks.patch sultan/reboot-hook.patch"
            extra_configs: "CONFIG_KSU_MANUAL_HOOK=y CONFIG_KSU_MANUAL_SU=n CONFIG_COMPAT=y CONFIG_ZRAM_GS_WRITEBACK=y CONFIG_KPM=y CONFIG_KALLSYMS=y CONFIG_KALLSYMS_ALL=y"
            ak3_suffix: "_SukiSU"
            #kpm: "https://raw.githubusercontent.com/ShirkNeko/SukiSU_patch/refs/heads/main/kpm/patch_linux"
          - type: xxKSU
            ksu: true
            exclude: susfs
            repo: "backslashxx/KernelSU"
            folder: "KernelSU"
            branch: "master"
            kernel_patches: "sultan/scope-min-hooks-v1.6.patch"
            ak3_suffix: "_xxKSU"
        kernel:
          - codename: gs201
            repo: "android_kernel_google_gs201"
            android_version: "android14"
            kernel_version: "6.1"
            defconfig: gs201_defconfig
            local_version: "-android14-11-g66e758f7d0c0-ab13748739"
            build_date: "Tue Jul  8 09:17:32 UTC 2025"
        exclude:
          - build:
              exclude: susfs
            susfs: true
          - build:
              exclude: susfsless
            susfs: false

    steps:
      - name: Download and extract GCC 14.2.0 toolchain
        run: |
          echo "Downloading GCC 14.2.0 cross-compiler toolchain..."
          wget https://www.kernel.org/pub/tools/crosstool/files/bin/x86_64/14.2.0/x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz -O gcc.tar.gz
          echo "Extracting .gz file..."
          gunzip gcc.tar.gz
          echo "Extracting .tar file..."
          tar -xf gcc.tar
          echo "GCC 14.2.0 toolchain extracted successfully"

      - name: Clone Dependencies and set ENV
        run: |
          ANYKERNEL_BRANCH="sultan-${{ matrix.kernel.codename }}"
          SUSFS_BRANCH="gki-${{ matrix.kernel.android_version }}-${{ matrix.kernel.kernel_version }}"

          sudo apt-get install -y --no-install-recommends ccache
          ccache --max-size=2G
          ccache --set-config=compression=true
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

          git clone --depth=1 https://github.com/TheWildJames/AnyKernel3.git -b "$ANYKERNEL_BRANCH" AK3
          echo "ak3_dir=$PWD/AK3" >> $GITHUB_ENV
          git clone --depth=5 https://gitlab.com/simonpunk/susfs4ksu.git -b "$SUSFS_BRANCH" susfs
          echo "susfs_dir=$PWD/susfs" >> $GITHUB_ENV
          git clone --depth=1 https://github.com/TheWildJames/kernel_patches.git james_patches
          echo "james_dir=$PWD/james_patches" >> $GITHUB_ENV
          git clone --depth=1 https://github.com/kerneltoast/${{ matrix.kernel.repo }} sultan
          echo "kernel_dir=$PWD/sultan" >> $GITHUB_ENV
          git clone --depth=1 https://github.com/TheSillyOk/kernel_ls_patches ok_patches
          echo "ok_dir=$PWD/ok_patches" >> $GITHUB_ENV

          ${{ matrix.susfs || false }} && ksu_repo="${{ matrix.build.susfs_repo || matrix.build.repo }}" || ksu_repo="${{ matrix.build.repo }}" || true
          echo "ksu_repo=$ksu_repo" >> $GITHUB_ENV
          ${{ matrix.susfs || false }} && ksu_branch="${{ matrix.build.susfs_branch || matrix.build.branch }}" || ksu_branch="${{ matrix.build.branch }}" || true
          echo "ksu_branch=$ksu_branch" >> $GITHUB_ENV

          build_type="${{ matrix.build.ak3_suffix }}"
          ${{ matrix.susfs }} && build_type="$build_type.SUSFS" || true
          date=$(date +"%d.%m.%Y")
          zip_name="$date-${{ matrix.kernel.codename }}${build_type}_A16_Sultan-${{ github.run_number }}"
          echo "zip_name=$zip_name" >> $GITHUB_ENV

      - name: Setup kernel stuff
        run: |
          cd "${{ env.kernel_dir }}"

          if [[ -n "${{ matrix.build.kernel_patches }}" ]]; then
            for patch_name in ${{ matrix.build.kernel_patches }}; do
              patch -p1 -F 3 < "${{ env.ok_dir }}/${patch_name}"
            done
          fi

          configs="CONFIG_TMPFS_XATTR=y CONFIG_TMPFS_POSIX_ACL=y CONFIG_IP_NF_TARGET_TTL=y CONFIG_IP6_NF_TARGET_HL=y CONFIG_IP6_NF_MATCH_HL=y CONFIG_TCP_CONG_ADVANCED=y CONFIG_TCP_CONG_BBR=y CONFIG_NET_SCH_FQ=y CONFIG_TCP_CONG_BIC=n CONFIG_TCP_CONG_WESTWOOD=n CONFIG_TCP_CONG_HTCP=n  CONFIG_DEFAULT_BBR=y CONFIG_BPF_STREAM_PARSER=y CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y CONFIG_NETFILTER_XT_SET=y CONFIG_IP_SET=y CONFIG_IP_SET_MAX=65534 CONFIG_IP_SET_BITMAP_IP=y CONFIG_IP_SET_BITMAP_IPMAC=y CONFIG_IP_SET_BITMAP_PORT=y CONFIG_IP_SET_HASH_IP=y CONFIG_IP_SET_HASH_IPMARK=y CONFIG_IP_SET_HASH_IPPORT=y CONFIG_IP_SET_HASH_IPPORTIP=y CONFIG_IP_SET_HASH_IPPORTNET=y CONFIG_IP_SET_HASH_IPMAC=y CONFIG_IP_SET_HASH_MAC=y CONFIG_IP_SET_HASH_NETPORTNET=y CONFIG_IP_SET_HASH_NET=y CONFIG_IP_SET_HASH_NETNET=y CONFIG_IP_SET_HASH_NETPORT=y CONFIG_IP_SET_HASH_NETIFACE=y CONFIG_IP_SET_LIST_SET=y CONFIG_IP6_NF_NAT=y CONFIG_IP6_NF_TARGET_MASQUERADE=y"
          if [[ -n "${{ matrix.build.extra_configs }}" ]]; then
            configs="$configs ${{ matrix.build.extra_configs }}"
          fi

          for config in $configs; do
            echo "--> Added ${config} <--"
            config_name=$(echo "${config}" | cut -d "=" -f 1)
            sed -i -E 's/.*($config_name=.*)/# \1/gi' ${{ env.kernel_dir }}/arch/arm64/configs/${{ matrix.kernel.defconfig }}
            echo -e "\n${config}" >> "${{ env.kernel_dir }}/arch/arm64/configs/${{ matrix.kernel.defconfig }}"
          done

          sed -i 's/${LOCALVERSION+set}/set/' ${{ env.kernel_dir }}/scripts/setlocalversion
          if [[ -n "${{ matrix.kernel.local_version }}" ]]; then
            sed -i 's/CONFIG_LOCALVERSION="-Sultan"/CONFIG_LOCALVERSION="${{ matrix.kernel.local_version }}"/' ${{ env.kernel_dir }}/arch/arm64/configs/${{ matrix.kernel.defconfig }}
          fi
          if [[ -n "${{ matrix.kernel.build_date }}" ]]; then
            perl -pi -e 's/build-timestamp = \$\(or \$\(KBUILD_BUILD_TIMESTAMP\), \$\(build-timestamp-auto\)\)/build-timestamp = "${{ matrix.kernel.build_date }}"/' ${{ env.kernel_dir }}/init/Makefile
          fi

      - name: Add KernelSU (${{ matrix.build.type }})
        if: matrix.build.ksu
        run: |
          cd "${{ env.kernel_dir }}"

          echo "Adding KernelSU..."
          curl -LSs "https://raw.githubusercontent.com/${{ env.ksu_repo }}/${{ env.ksu_branch }}/kernel/setup.sh" | bash -s ${{ env.ksu_branch }}
          if [[ -n "${{ matrix.build.checkout }}" ]]; then
            cd "${{ matrix.build.folder }}" && git checkout "${{ matrix.build.checkout }}" && cd -
          fi

          if [[ -n "${{ matrix.build.susfsless_kernel_patches }}" && "${{ matrix.susfs }}" != "true" ]]; then
            for patch_name in ${{ matrix.build.susfsless_kernel_patches }}; do
              patch -p1 -F 3 < "${{ env.ok_dir }}/${patch_name}"
            done
          fi

          if [[ -n "${{ matrix.build.susfsless_ksu_patches }}" && "${{ matrix.susfs }}" != "true" ]]; then
            cd "${{ matrix.build.folder }}"
            for patch_name in ${{ matrix.build.susfsless_ksu_patches }}; do
              patch -p1 < "${{ env.ok_dir }}/${patch_name}"
            done
            cd "${{ env.kernel_dir }}"
          fi

          if [[ -n "${{ matrix.build.ksu_patches }}" ]]; then
            cd "${{ matrix.build.folder }}"
            for patch_name in ${{ matrix.build.ksu_patches }}; do
              patch -p1 < "${{ env.ok_dir }}/${patch_name}"
            done
            cd "${{ env.kernel_dir }}"
          fi

          if [[ -n "${{ matrix.build.susfsless_configs }}" && "${{ matrix.susfs }}" != "true" ]]; then
            for config in ${{ matrix.build.susfsless_configs }}; do
              echo "--> Added ${config} <--"
              config_name=$(echo "${config}" | cut -d "=" -f 1)
              sed -i -E 's/.*($config_name=.*)/# \1/gi' ${{ env.kernel_dir }}/arch/arm64/configs/${{ matrix.kernel.defconfig }}
              echo -e "\n${config}" >> "${{ env.kernel_dir }}/arch/arm64/configs/${{ matrix.kernel.defconfig }}"
            done
          fi

      - name: Apply SUSFS Patches
        if: matrix.susfs
        run: |

          cp ${{ env.susfs_dir }}/kernel_patches/50_add_susfs_in_gki-${{ matrix.kernel.android_version }}-${{ matrix.kernel.kernel_version }}.patch ${{ env.kernel_dir }}/
          cp ${{ env.susfs_dir }}/kernel_patches/fs/* ${{ env.kernel_dir }}/fs/
          cp ${{ env.susfs_dir }}/kernel_patches/include/linux/* ${{ env.kernel_dir }}/include/linux/

          if [[ -n "${{ matrix.build.susfs_ksu_patches }}" ]]; then
            cd "${{ env.kernel_dir }}/${{ matrix.build.folder }}"
            for patch_name in ${{ matrix.build.susfs_ksu_patches }}; do
              patch -p1 -F 3 < "${{ env.ok_dir }}/${patch_name}"
            done
          fi

          if [[ -n "${{ matrix.build.susfs_kernel_patches }}" ]]; then
            for patch_name in ${{ matrix.build.susfs_kernel_patches }}; do
              patch -p1 -F 3 < "${{ env.ok_dir }}/${patch_name}"
            done
            cd "${{ env.kernel_dir }}"
          fi

          cd "${{ env.kernel_dir }}"
          patch -p1 < 50_add_susfs_in_gki-${{ matrix.kernel.android_version }}-${{ matrix.kernel.kernel_version }}.patch || true
          patch -p1 --fuzz=3 < ${{ env.james_dir }}/sultan/sys.c_fix.patch

          if [[ -n "${{ matrix.build.susfs_configs }}" ]]; then
            for config in ${{ matrix.build.susfs_configs }}; do
              echo "--> Added ${config} <--"
              config_name=$(echo "${config}" | cut -d "=" -f 1)
              sed -i -E 's/.*($config_name=.*)/# \1/gi' ${{ env.kernel_dir }}/arch/arm64/configs/${{ matrix.kernel.defconfig }}
              echo -e "\n${config}" >> "${{ env.kernel_dir }}/arch/arm64/configs/${{ matrix.kernel.defconfig }}"
            done
          fi

      - name: Cache Kernel Build
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ matrix.kernel.codename }}-${{ matrix.build.type }}-SUSFS_${{ matrix.susfs }}-ccache-${{ github.sha }}-${{ github.run_number }}
          restore-keys: |
            ${{ matrix.kernel.codename }}-${{ matrix.build.type }}-SUSFS_${{ matrix.susfs }}-ccache-
            ${{ matrix.kernel.codename }}-${{ matrix.build.type }}-
            ${{ matrix.kernel.codename }}-

      - name: Build the Kernel
        run: |
          cd "${{ env.kernel_dir }}"

          export KBUILD_BUILD_USER="TheSillyOk"
          export KBUILD_BUILD_HOST="Github"

          make CROSS_COMPILE=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux- CC=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-gcc -j$(nproc --all) ${{ matrix.kernel.defconfig }}
          make CROSS_COMPILE="ccache $GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-" CC="ccache $GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-gcc" -j$(nproc --all)

      - name: Setup AnyKernel3 zip and KPM
        run: |
          cd "${{ env.kernel_dir }}"

          echo "Copying Image.lz4 and concatenating DTB files..."
          cp ./out/arch/arm64/boot/Image.lz4 ${{ env.ak3_dir }}/Image.lz4
          cat ./out/google-devices/${{ matrix.kernel.codename }}/dts/*.dtb > ${{ env.ak3_dir }}/dtb

          if [[ -n "${{ matrix.build.kpm }}" ]]; then
            cd ${{ env.ak3_dir }}
            curl -LSs "${{ matrix.build.kpm }}" -o patch && chmod 777 patch
            img_file=$(find . -type f -name "Image"* -maxdepth 1)
            echo "$img_file"

            # Decompress the kernel image if it's compressed
            if [[ "$img_file" == "./Image.gz"* ]]; then
              dd if="$img_file" bs=1 | gunzip > Image || true
              echo "-> Convert to: Image"
            elif [[ "$img_file" == "./Image.lz4" ]]; then
              lz4 -d "$img_file" Image
              echo "-> Decompress to: Image"
            fi

            ./patch && mv oImage Image

            # Re-compress the kernel image to its original format
            if [[ "$img_file" == "./Image.gz"* ]]; then
              gzip -c Image > Image.gz
              rm Image
              echo "-> Compress: Image.gz"
              # Special handling for images with appended DTB
              if [[ "$img_file" == "./Image.gz-dtb" ]]; then
                compressed_length=$(dd if=Image.gz-dtb bs=1 $skip | gzip -c | wc -c)
                dd if=Image.gz-dtb bs=1 skip=$compressed_length > dtb
                cat Image.gz dtb > Image.gz-dtb
                rm Image.gz && rm dtb
                echo "-- Image.gz -> Image.gz-dtb"
              fi
            elif [[ "$img_file" == "./Image.lz4" ]]; then
              lz4 -f Image Image.lz4
              rm Image
              echo "-> Compress: Image.lz4"
            fi

            rm patch
            cd -
          fi

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.zip_name }}
          path: ${{ env.ak3_dir }}/*

  release:
    needs: build
    if: github.event_name != 'pull_request'
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./downloaded-artifacts

      - name: Set Release Variables
        id: release_vars
        run: |
          echo "date=$(date +"%d/%m/%Y")" >> $GITHUB_ENV

          git clone --depth=1 "https://github.com/TheSillyOk/sh" "sh"

          echo "sh_dir=$PWD/sh" >> $GITHUB_ENV
          echo "artifacts_dir=$PWD/downloaded-artifacts" >> $GITHUB_ENV

          KSU_URL=$(git ls-remote https://github.com/tiann/KernelSU HEAD | awk '{print "https://github.com/tiann/KernelSU/commit/"$1}')
          KSUN_URL=$(git ls-remote https://github.com/KernelSU-Next/KernelSU-Next.git next | awk '{print "https://github.com/KernelSU-Next/KernelSU-Next/commit/"$1}')
          RKSU_URL=$(git ls-remote https://github.com/rsuntk/KernelSU HEAD | awk '{print "https://github.com/rsuntk/KernelSU/commit/"$1}')
          SUKI_URL=$(git ls-remote https://github.com/SukiSU-Ultra/SukiSU-Ultra HEAD | awk '{print "https://github.com/SukiSU-Ultra/SukiSU-Ultra/commit/"$1}')
          xxKSU_URL=$(git ls-remote https://github.com/backslashxx/KernelSU HEAD | awk '{print "https://github.com/backslashxx/KernelSU/commit/"$1}')
          echo "KSU_URL=$KSU_URL" >> $GITHUB_ENV
          echo "KSUN_URL=$KSUN_URL" >> $GITHUB_ENV
          echo "RKSU_URL=$RKSU_URL" >> $GITHUB_ENV
          echo "SUKI_URL=$SUKI_URL" >> $GITHUB_ENV
          echo "xxKSU_URL=$xxKSU_URL" >> $GITHUB_ENV

          echo "KSU_V=$(./sh/get_ksuver.sh "tiann" "KernelSU" "main")" >> $GITHUB_ENV
          echo "KSUN_V=$(./sh/get_ksuver.sh "KernelSU-Next" "KernelSU-Next" "next")" >> $GITHUB_ENV
          echo "RKSU_V=$(./sh/get_ksuver.sh "rsuntk" "KernelSU" "main")" >> $GITHUB_ENV
          echo "SUKI_V=$(./sh/get_ksuver.sh "SukiSU-Ultra" "SukiSU-Ultra" "main")" >> $GITHUB_ENV
          echo "xxKSU_V=$(./sh/get_ksuver.sh "backslashxx" "KernelSU" "master")" >> $GITHUB_ENV

      - name: Generate Release Body
        id: release_body
        run: |
          cat << EOF > release_body.md
          ‚ö†Ô∏è **COMPATIBILITY NOTICE** ‚ö†Ô∏è
          Please ensure compatibility by comparing release dates with official Sultan kernel releases
          
          Module:
          -> https://github.com/sidex15/ksu_module_susfs
          
          Managers:
          -> https://github.com/WildKernels/Wild_KSU
          -> https://github.com/KernelSU-Next/KernelSU-Next
          -> https://github.com/rsuntk/KernelSU
          -> https://github.com/SukiSU-Ultra/SukiSU-Ultra
          -> https://github.com/backslashxx/KernelSU/releases / https://t.me/kowsu_build
          
          Features:
          [+] KSUN [${{ env.KSUN_V }}](${{ env.KSUN_URL }}) + WKSU Manager
          [+] RKSU [${{ env.RKSU_V }}](${{ env.RKSU_URL }})
          [+] SukiSU [${{ env.SUKI_V }}](${{ env.SUKI_URL }})
          [+] xxKSU [${{ env.xxKSU_V }}](${{ env.xxKSU_URL }})
          [+] SUSFS v1.5.12
          EOF

      - name: Set release tag
        env:
         GH_TOKEN: ${{ github.token }}
        run: |
            gh auth setup-git
            git clone --depth=1 "https://github.com/${{ github.repository }}" --depth=1 --branch="${{ github.ref_name }}" repo
            cd repo
            echo "repo_dir=$PWD" >> $GITHUB_ENV

            TAG=$(date +"%Y/%m/%d")
            LATEST_TAG=$(gh api repos/${{ github.repository }}/tags --jq '.[0].name')

            if [[ "$LATEST_TAG" == "$TAG"* ]]; then
              echo "$TAG* == $LATEST_TAG"
              TAG=$(echo "$LATEST_TAG" | awk -F'-r' '{suffix=$2; if (!suffix) suffix=0; suffix++; printf "%s-r%d", $1, suffix}')
            else
              echo "First release of the day"
              TAG="$TAG-r1"
            fi

            gh release delete "$TAG" -y || true
            echo "Created tag: $TAG"
            echo "TAG=$TAG" >> $GITHUB_ENV
            git tag $TAG || true
            git push origin $TAG || true

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: ${{ env.date }}
          body_path: release_body.md

      - name: Upload Release Assets
        env:
         GH_TOKEN: ${{ github.token }}
        run: |
          bash ${{ env.sh_dir }}/upload-assets.sh "${{ env.TAG }}" "${{ env.repo_dir }}" "${{ env.artifacts_dir }}"
name: Sultan Test

permissions:
  contents: write
  actions: write

on:
  workflow_call:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  

jobs:
  build:
    runs-on: ubuntu-latest
    if: >
      ${{ 
        github.event_name != 'pull_request' ||
        contains(github.event.pull_request.labels.*.name, 'build')
      }}
    name: >-
      Sultan-
      ${{ matrix.build.type }}${{ matrix.susfs && '_SUSFS' || '' }}
    outputs:
      release_tag: ${{ steps.tag.outputs.tag }}
    strategy:
      fail-fast: false
      matrix:
        kernel:
          - codename: gs201
            repo: "android_kernel_google_gs201"
            android_version: "android14"
            kernel_version: "6.1"
            sub_level: "134"
            defconfig: gs201_defconfig
            local_version: "-android14-11-g66e758f7d0c0-ab13748739"
            build_date: "Tue Jul 8 09:17:32 UTC 2025"
        build:
          - type: SukiSU
            name: "SukiSU"
            ksu: true
            repo: "SukiSU-Ultra/SukiSU-Ultra"
            folder: "KernelSU"
            branch: "main"
            susfs_repo: "SukiSU-Ultra/SukiSU-Ultra"
            susfs_branch: "susfs-main"
            kernel_patches: "sultan/scope-min-hooks-v1.6.patch"
            extra_configs: |
              CONFIG_KPM=y
              CONFIG_KALLSYMS=y
              CONFIG_KALLSYMS_ALL=y
              CONFIG_KSU_SUSFS=y
              CONFIG_KSU_MANUAL_SU=n
              CONFIG_COMPAT=y
              CONFIG_ZRAM_GS_WRITEBACK=y
            ak3_suffix: "_SukiSU"
            
          - type: MKSU
            name: "MKSU"
            ksu: true
            repo: "5ec1cff/KernelSU"
            folder: "KernelSU"
            branch: "main"
            ksu_kernel_patches: "mksu/0001-50_add_susfs_to_kernelside_5ec1cff.patch"
            mksu_patches: "mksu/0001-10_enable_susfs_for_ksu_5ec1cff.patch"
            ak3_suffix: "_MKSU"
            extra_configs: |
              CONFIG_KSU_EXTRAS=y
              CONFIG_KSU_KRETPROBES_SUCOMPAT=y
              CONFIG_KSU_THRONE_TRACKER_ALWAYS_THREADED=y
            
          - type: KowSU
            name: "KowSU"
            ksu: true
            repo: "KOWX712/KernelSU"
            folder: "KernelSU"
            branch: "master"
            ksu_kernel_patches: "kowsu/0001-50_add_susfs_to_kernelside_KOWX712.patch"
            kowsu_patches: "kowsu/0001-10-add_SuSFS_to_KernelSU_KOWX712.patch"
            ak3_suffix: "_KowSU"
            #extra_configs: |
            #  CONFIG_KSU_EXTRAS=y
            #  CONFIG_KSU_KRETPROBES_SUCOMPAT=y
            #  CONFIG_KSU_THRONE_TRACKER_ALWAYS_THREADED=y
            
          - type: xxKSU
            name: "xxKSU"
            ksu: true
            repo: "backslashxx/KernelSU"
            folder: "KernelSU"
            branch: "master"
            kernel_patches: "sultan/scope-min-hooks-v1.6.patch"
            ak3_suffix: "_xxKSU"
            extra_configs: |
              CONFIG_KSU_EXTRAS=y
              CONFIG_KSU_KRETPROBES_SUCOMPAT=y
              CONFIG_KSU_THRONE_TRACKER_ALWAYS_THREADED=y
        
        susfs: [false, true]
        
        # ‰ΩøÁî® exclude ÊéíÈô§‰∏çÈúÄË¶ÅÁöÑÁªÑÂêàÔºà‰∏éGKI‰∏ÄËá¥Ôºâ
        exclude:
          # ÊéíÈô§ SukiSU Ê≤°Êúâ SUSFS ÁöÑÊÉÖÂÜµ
          - build:
              type: SukiSU
            
          
          # ÊéíÈô§ MKSU 
          - build:
              type: MKSU
            
          
          # ÊéíÈô§ KowSU Ê≤°Êúâ SUSFS ÁöÑÊÉÖÂÜµ
          - build:
              type: KowSU
            susfs: false
          
          # ÊéíÈô§ xxKSU Êúâ SUSFS ÁöÑÊÉÖÂÜµ
          - build:
              type: xxKSU
            susfs: true

    steps:
      - name: Download and extract GCC 14.2.0 toolchain
        run: |
          echo "Downloading GCC 14.2.0..."
          wget -q https://kernel.org/pub/tools/crosstool/files/bin/x86_64/14.2.0/x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz -O gcc.tar.gz
          gunzip gcc.tar.gz
          tar -xf gcc.tar
          echo "GCC 14.2.0 ready"

      - name: Clone Dependencies and Set ENV
        run: |
          ANYKERNEL_BRANCH="sultan-${{ matrix.kernel.codename }}"
          SUSFS_BRANCH="gki-${{ matrix.kernel.android_version }}-${{ matrix.kernel.kernel_version }}"

          sudo apt-get update && sudo apt-get install -y ccache
          ccache --max-size=2G
          ccache --set-config=compression=true
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

          git clone --depth=1 https://github.com/TheWildJames/AnyKernel3.git -b "$ANYKERNEL_BRANCH" AK3
          echo "ak3_dir=$PWD/AK3" >> $GITHUB_ENV

          git clone --depth=5 https://gitlab.com/simonpunk/susfs4ksu.git -b "$SUSFS_BRANCH" susfs
          echo "susfs_dir=$PWD/susfs" >> $GITHUB_ENV

          git clone --depth=1 https://github.com/TheWildJames/kernel_patches.git james_patches
          echo "james_dir=$PWD/james_patches" >> $GITHUB_ENV

          git clone --depth=1 https://github.com/TheSillyOk/kernel_ls_patches ok_patches
          echo "ok_dir=$PWD/ok_patches" >> $GITHUB_ENV

          git clone --depth=1 https://github.com/yapixel/kernel_patches yapixel_patches
          echo "yapixel_dir=$PWD/yapixel_patches" >> $GITHUB_ENV

          git clone --depth=1 https://github.com/kerneltoast/${{ matrix.kernel.repo }} sultan
          echo "kernel_dir=$PWD/sultan" >> $GITHUB_ENV

          # === CLONE SH SCRIPTS ONCE ===
          git clone --depth=1 https://github.com/TheSillyOk/sh sh

          # === GET KSU VARIANT & VERSION ===
          KSU_VARIANT="${{ matrix.build.type }}"
          KSU_VER="unknown"

          case "$KSU_VARIANT" in
            "SukiSU")
              KSU_VER=$(./sh/extract_ksuver.sh "https://github.com/SukiSU-Ultra/SukiSU-Ultra" "kernel/Makefile" "." "susfs-main" || echo "unknown")
              ;;
            "xxKSU")
              KSU_VER=$(./sh/extract_ksuver.sh "https://github.com/backslashxx/KernelSU" "kernel/Makefile" "." "master"|| echo "unknown")
              ;;
            "KowSU")
              KSU_VER=$(./sh/get_ksuver.sh "KOWX712" "KernelSU" "master" || echo "unknown")
              ;;
            "MKSU")
              KSU_VER=$(./sh/get_ksuver.sh "5ec1cff" "KernelSU" "main" || echo "unknown")
              ;;
          esac

          echo "KSU_VARIANT=$KSU_VARIANT" >> $GITHUB_ENV
          echo "KSU_VER=$KSU_VER" >> $GITHUB_ENV

          # === FINAL ZIP NAME ===
          ZIP_NAME="Sultan-${{ matrix.kernel.kernel_version }}.${{ matrix.kernel.sub_level }}-${KSU_VARIANT}-r${KSU_VER}${{ matrix.susfs && '-SUSFS' || '' }}.zip"
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: Apply Kernel Patches
        run: |
          cd "${{ env.kernel_dir }}"

          # Apply general kernel patches
          if [[ -n "${{ matrix.build.kernel_patches }}" ]]; then
            for p in ${{ matrix.build.kernel_patches }}; do
              patch -p1 -F 3 < "${{ env.ok_dir }}/$p" && echo "Applied kernel patch: $p"
            done
          fi

      - name: Add KernelSU
        if: matrix.build.ksu
        run: |
          cd "${{ env.kernel_dir }}"

          REPO="${{ matrix.build.susfs_repo || matrix.build.repo }}"
          BRANCH="${{ matrix.build.susfs_branch || matrix.build.branch }}"

          echo "Using latest from branch: $BRANCH (from $REPO)"
          curl -fsSL "https://raw.githubusercontent.com/$REPO/$BRANCH/kernel/setup.sh" | \
            bash -s -- "$BRANCH"

      - name: Apply KSU Variant Patches to KernelSU Directory
        if: matrix.build.ksu
        run: |
          cd "${{ env.kernel_dir }}/KernelSU"
          
          echo "=== Applying KSU variant patches to KernelSU directory ==="
          
          # KowSU KSUÁõÆÂΩïÁ∫ßÂà´Ë°•‰∏Å
          if [[ "${{ matrix.build.type }}" == "KowSU" && -n "${{ matrix.build.kowsu_patches }}" ]]; then
            echo "üîß Applying KowSU KSU-directory patches..."
            for patch in ${{ matrix.build.kowsu_patches }}; do
              echo "Applying KSU patch: $patch"
              cp "${{ env.yapixel_dir }}/$patch" ./
              patch -p1 < "$(basename "$patch")" || true
              rm -f "$(basename "$patch")"
            done
          fi

          # MKSU KSUÁõÆÂΩïÁ∫ßÂà´Ë°•‰∏Å
          if [[ "${{ matrix.build.type }}" == "MKSU" && -n "${{ matrix.build.mksu_patches }}" ]]; then
            echo "üîß Applying MKSU KSU-directory patches..."
            for patch in ${{ matrix.build.mksu_patches }}; do
              echo "Applying KSU patch: $patch"
              cp "${{ env.yapixel_dir }}/$patch" ./
              patch -p1 < "$(basename "$patch")" || true
              rm -f "$(basename "$patch")"
            done
          fi

      - name: Apply SUSFS Patches for KernelSU Variants
        if: matrix.susfs
        run: |
          cd "${{ env.kernel_dir }}"
          
          echo "=== Applying SUSFS patches for ${{ matrix.build.type }} ==="
          
          # Â§çÂà∂ SUSFS Êñá‰ª∂
          echo "Copying SUSFS files..."
          cp -r "${{ env.susfs_dir }}/kernel_patches/fs/"* fs/ 2>/dev/null || true
          cp -r "${{ env.susfs_dir }}/kernel_patches/include/linux/"* include/linux/ 2>/dev/null || true

          # KowSU ÂÜÖÊ†∏Á∫ßÂà´ SUSFS Ë°•‰∏Å
          if [[ "${{ matrix.build.type }}" == "KowSU" && -n "${{ matrix.build.ksu_kernel_patches }}" ]]; then
            echo "üîß Applying KowSU kernel SUSFS patches..."
            for p in ${{ matrix.build.ksu_kernel_patches }}; do
              echo "Applying kernel patch: $p"
              cp "${{ env.yapixel_dir }}/$p" ./
              patch --fuzz=10 -p1 < "$(basename "$p")" || true
              # Ê∏ÖÁêÜÂèØËÉΩÁöÑÂÜ≤Á™ÅÊñá‰ª∂
              rm -f fs/proc/base.c.rej fs/proc/base.c.orig 2>/dev/null || true
              rm -f "$(basename "$p")"
            done
          fi

          # MKSU ÂÜÖÊ†∏Á∫ßÂà´ SUSFS Ë°•‰∏Å
          if [[ "${{ matrix.build.type }}" == "MKSU" && -n "${{ matrix.build.ksu_kernel_patches }}" ]]; then
            echo "üîß Applying MKSU kernel SUSFS patches..."
            for p in ${{ matrix.build.ksu_kernel_patches }}; do
              echo "Applying kernel patch: $p"
              cp "${{ env.yapixel_dir }}/$p" ./
              patch --fuzz=10 -p1 < "$(basename "$p")" || true
              # Ê∏ÖÁêÜÂèØËÉΩÁöÑÂÜ≤Á™ÅÊñá‰ª∂
              rm -f fs/proc/base.c.rej fs/proc/base.c.orig 2>/dev/null || true
              rm -f "$(basename "$p")"
            done
          fi

          # SukiSU ‰ΩøÁî®Ê†áÂáÜÁöÑ SUSFS Ë°•‰∏Å
          if [[ "${{ matrix.build.type }}" == "SukiSU" ]]; then
            echo "üîß Applying standard SUSFS main patch for SukiSU..."
            PATCH_FILE="50_add_susfs_in_gki-${{ matrix.kernel.android_version }}-${{ matrix.kernel.kernel_version }}.patch"
            cp "${{ env.susfs_dir }}/kernel_patches/$PATCH_FILE" "./$PATCH_FILE"
            patch --fuzz=10 -p1 < "$PATCH_FILE" || true
            # Ê∏ÖÁêÜÂèØËÉΩÁöÑÂÜ≤Á™ÅÊñá‰ª∂
            rm -f fs/proc/base.c.rej fs/proc/base.c.orig 2>/dev/null || true
            rm -f "$PATCH_FILE"
          fi

      - name: Apply Final sys.c Fix Patch
        run: |
          cd "${{ env.kernel_dir }}"
          # Âú®ÊâÄÊúâË°•‰∏ÅÂ∫îÁî®ÂÆåÊàêÂêéÔºåÊúÄÂêéÂ∫îÁî® sys.c fix
          echo "üîß Applying final sys.c fix patch after all other patches..."
          patch -p1 --fuzz=3 < "${{ env.james_dir }}/sultan/sys.c_fix.patch" || true

      - name: Setup Kernel Configs
        run: |
          cd "${{ env.kernel_dir }}"

          # Base configs
          configs="CONFIG_TMPFS_XATTR=y CONFIG_TMPFS_POSIX_ACL=y CONFIG_IP_NF_TARGET_TTL=y CONFIG_IP6_NF_TARGET_HL=y CONFIG_IP6_NF_MATCH_HL=y CONFIG_TCP_CONG_ADVANCED=y CONFIG_TCP_CONG_BBR=y CONFIG_NET_SCH_FQ=y CONFIG_TCP_CONG_BIC=n CONFIG_TCP_CONG_WESTWOOD=n CONFIG_TCP_CONG_HTCP=n CONFIG_DEFAULT_BBR=y CONFIG_BPF_STREAM_PARSER=y CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y CONFIG_NETFILTER_XT_SET=y CONFIG_IP_SET=y CONFIG_IP_SET_MAX=65534 CONFIG_IP_SET_BITMAP_IP=y CONFIG_IP_SET_BITMAP_IPMAC=y CONFIG_IP_SET_BITMAP_PORT=y CONFIG_IP_SET_HASH_IP=y CONFIG_IP_SET_HASH_IPMARK=y CONFIG_IP_SET_HASH_IPPORT=y CONFIG_IP_SET_HASH_IPPORTIP=y CONFIG_IP_SET_HASH_IPPORTNET=y CONFIG_IP_SET_HASH_IPMAC=y CONFIG_IP_SET_HASH_MAC=y CONFIG_IP_SET_HASH_NETPORTNET=y CONFIG_IP_SET_HASH_NET=y CONFIG_IP_SET_HASH_NETNET=y CONFIG_IP_SET_HASH_NETPORT=y CONFIG_IP_SET_HASH_NETIFACE=y CONFIG_IP_SET_LIST_SET=y CONFIG_IP6_NF_NAT=y CONFIG_IP6_NF_TARGET_MASQUERADE=y CONFIG_KSU=y"
          
          # Ê∑ªÂä†Âèò‰ΩìÁâπÂÆöÁöÑÈÖçÁΩÆ
          echo '${{ matrix.build.extra_configs }}' | tr '|' '\n' >> temp_configs.txt
          while IFS= read -r line; do
            if [[ -n "$line" ]]; then
              configs="$configs $line"
            fi
          done < temp_configs.txt
          rm -f temp_configs.txt

          # SUSFS ÈÖçÁΩÆ
          if [[ "${{ matrix.susfs }}" == "true" ]]; then
            configs="$configs CONFIG_SUSFS=y CONFIG_KSU_SUSFS=y CONFIG_KSU_SUSFS_SUS_PATH=y CONFIG_KSU_SUSFS_SUS_MOUNT=y CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y CONFIG_KSU_SUSFS_SPOOF_UNAME=y CONFIG_KSU_SUSFS_ENABLE_LOG=y CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y"
          fi

          # Â∫îÁî®ÊâÄÊúâÈÖçÁΩÆ
          for config in $configs; do
            name=$(echo "$config" | cut -d'=' -f1)
            sed -i -E "s/.*($name=.*)/# \1 is not set/gi" arch/arm64/configs/${{ matrix.kernel.defconfig }}
            echo "$config" >> arch/arm64/configs/${{ matrix.kernel.defconfig }}
          done

          # ËÆæÁΩÆÁâàÊú¨‰ø°ÊÅØ
          sed -i 's/${LOCALVERSION+set}/set/' scripts/setlocalversion
          sed -i 's/CONFIG_LOCALVERSION="-Sultan"/CONFIG_LOCALVERSION="${{ matrix.kernel.local_version }}"/' arch/arm64/configs/${{ matrix.kernel.defconfig }}
          perl -pi -e 's/build-timestamp = \$\(or \$\(KBUILD_BUILD_TIMESTAMP\), \$\(build-timestamp-auto\)\)/build-timestamp = "${{ matrix.kernel.build_date }}"/' init/Makefile

      - name: Cache Kernel Build
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: sultan-${{ matrix.kernel.codename }}-${{ matrix.build.type }}-susfs${{ matrix.susfs }}-ccache-${{ github.sha }}
          restore-keys: |
            sultan-${{ matrix.kernel.codename }}-${{ matrix.build.type }}-susfs${{ matrix.susfs }}-ccache-

      - name: Build Kernel
        run: |
          cd "${{ env.kernel_dir }}"
          export KBUILD_BUILD_USER="build-user"
          export KBUILD_BUILD_HOST="build-host"
          make O=out CROSS_COMPILE=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux- CC=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-gcc ${{ matrix.kernel.defconfig }}
          make O=out CROSS_COMPILE="ccache $GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-" CC="ccache $GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-gcc" -j$(nproc --all)

      - name: Package AnyKernel3
        run: |
          cp "${{ env.kernel_dir }}/out/arch/arm64/boot/Image.lz4" "${{ env.ak3_dir }}/Image.lz4"
          cat "${{ env.kernel_dir }}/out/google-devices/${{ matrix.kernel.codename }}/dts/"*.dtb \
              > "${{ env.ak3_dir }}/dtb"

          cd "${{ env.ak3_dir }}"
          zip -r9 "${GITHUB_WORKSPACE}/${{ env.ZIP_NAME }}" . -x "*.git*" "README.md" "placeholder"
          cd "${GITHUB_WORKSPACE}"

          sha256sum "${{ env.ZIP_NAME }}" > "${{ env.ZIP_NAME }}.sha256"
          echo "ZIP_FULLPATH=${GITHUB_WORKSPACE}/${{ env.ZIP_NAME }}" >> "$GITHUB_ENV"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ matrix.build.type }}${{ matrix.susfs && '-SUSFS' || '' }}
          path: |
            ${{ env.ZIP_FULLPATH }}
            ${{ env.ZIP_FULLPATH }}.sha256

      - name: Create Daily Release Tag
        id: tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE_TAG=$(date +"%Y/%m/%d")
          LATEST=$(gh api "repos/${{ github.repository }}/tags" --jq '.[0].name' 2>/dev/null || echo "")

          if [[ -n "$LATEST" && "$LATEST" == "$BASE_TAG"* ]]; then
            REV=$(echo "$LATEST" | grep -o 'r[0-9]*$' | sed 's/^r//' || echo "0")
            REV=$((REV + 1))
            TAG="${BASE_TAG}-r${REV}"
          else
            TAG="${BASE_TAG}-r1"
          fi

          gh api -X DELETE "/repos/${{ github.repository }}/git/refs/tags/$TAG" > /dev/null 2>&1 || true
          gh api -X POST "/repos/${{ github.repository }}/git/refs" \
            -f ref="refs/tags/$TAG" \
            -f sha="${{ github.sha }}" || exit 1

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV

  release:
    needs: build
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Set Release Info
        id: info
        run: |
          echo "date=$(date +"%d/%m/%Y")" >> $GITHUB_ENV
          git clone --depth=1 https://github.com/TheSillyOk/sh sh
          echo "sh_dir=$PWD/sh" >> $GITHUB_ENV

          SUKI_URL=$(git ls-remote https://github.com/SukiSU-Ultra/SukiSU-Ultra main | awk '{print "https://github.com/SukiSU-Ultra/SukiSU-Ultra/commit/"$1}')
          XXKSU_URL=$(git ls-remote https://github.com/backslashxx/KernelSU master | awk '{print "https://github.com/backslashxx/KernelSU/commit/"$1}')
          KOWSU_URL=$(git ls-remote https://github.com/KOWX712/KernelSU master | awk '{print "https://github.com/KOWX712/KernelSU/commit/"$1}')
          MKSU_URL=$(git ls-remote https://github.com/5ec1cff/KernelSU main | awk '{print "https://github.com/5ec1cff/KernelSU/commit/"$1}')

          SUKI_V=$(./sh/extract_ksuver.sh "https://github.com/SukiSU-Ultra/SukiSU-Ultra" "kernel/Makefile" "." "main" || echo "unknown")
          XXKSU_V=$(./sh/extract_ksuver.sh "https://github.com/backslashxx/KernelSU" "kernel/Makefile" "." "master" || echo "unknown")
          KOWSU_V=$(./sh/get_ksuver.sh "KOWX712" "KernelSU" "master")
          MKSU_V=$(./sh/get_ksuver.sh "5ec1cff" "KernelSU" "main")

          echo "SUKI_URL=$SUKI_URL" >> $GITHUB_ENV
          echo "XXKSU_URL=$XXKSU_URL" >> $GITHUB_ENV
          echo "KOWSU_URL=$KOWSU_URL" >> $GITHUB_ENV
          echo "MKSU_URL=$MKSU_URL" >> $GITHUB_ENV
          echo "SUKI_V=$SUKI_V" >> $GITHUB_ENV
          echo "XXKSU_V=$XXKSU_V" >> $GITHUB_ENV
          echo "KOWSU_V=$KOWSU_V" >> $GITHUB_ENV
          echo "MKSU_V=$MKSU_V" >> $GITHUB_ENV

      - name: Generate Release Body
        id: release_body
        run: |
          cat << EOF > release_body.md
          ‚ö†Ô∏è **COMPATIBILITY NOTICE** ‚ö†Ô∏è
          Please ensure compatibility by comparing release dates with official Sultan kernel releases
          
          Module:
          -> https://github.com/sidex15/ksu_module_susfs
          
          Managers:
          -> https://github.com/5ec1cff/KernelSU
          -> https://github.com/backslashxx/KernelSU
          -> https://github.com/KOWX712/KernelSU
          -> https://github.com/SukiSU-Ultra/SukiSU-Ultra
          
          Features:
          [+] KowSU [${{ env.KOWSU_V }}](${{ env.KOWSU_URL }})
          [+] SukiSU [${{ env.SUKI_V }}](${{ env.SUKI_URL }})
          [+] xxKSU [${{ env.XXKSU_V }}](${{ env.XXKSU_URL }})
          [+] MKSU  [${{ env.MKSU_V }}](${{ env.MKSU_URL }})
          [+] SUSFS v2.0.0
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.release_tag }}
          name: Sultan Kernel - ${{ env.date }}
          body_path: release_body.md
          files: ./artifacts/**/*.zip
          fail_on_unmatched_files: true
