name: Sultan

permissions:
  contents: write
  actions: write

on:
  workflow_call:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

jobs:
  build:
    runs-on: ubuntu-latest
    if: >
      ${{ 
        github.event_name != 'pull_request' ||
        contains(github.event.pull_request.labels.*.name, 'build')
      }}
    name: >-
      Sultan-
      ${{ matrix.build.type }}${{ matrix.susfs && '_SUSFS' || '' }}
    outputs:
      release_tag: ${{ steps.tag.outputs.tag }}
    strategy:
      fail-fast: false
      matrix:
        kernel:
          - codename: gs201
            repo: "android_kernel_google_gs201"
            android_version: "android14"
            kernel_version: "6.1"
            sub_level: "134"
            defconfig: gs201_defconfig
            local_version: "-android14-11-g66e758f7d0c0-ab13748739"
            build_date: "Tue Jul 8 09:17:32 UTC 2025"
        build:
          - type: SukiSU
            name: "SukiSU"
            ksu: true
            repo: "SukiSU-Ultra/SukiSU-Ultra"
            folder: "KernelSU"
            branch: "main"
            susfs_repo: "SukiSU-Ultra/SukiSU-Ultra"
            susfs_branch: "susfs-main"
            kernel_patches: |
              sultan/scope-min-hooks-v1.6.patch
              SukiSU_KernelPatch_patch/KPM.patch
            extra_configs: |
              CONFIG_KPM=y
              CONFIG_KALLSYMS=y
              CONFIG_KALLSYMS_ALL=y
              CONFIG_KSU_SUSFS=y
              CONFIG_KSU_MANUAL_SU=n
              CONFIG_COMPAT=y
              CONFIG_ZRAM_GS_WRITEBACK=y
            ak3_suffix: "_SukiSU"
          - type: MKSU
            name: "MKSU"
            ksu: true
            repo: "5ec1cff/KernelSU"
            folder: "KernelSU"
            branch: "main"
            ksu_kernel_patches: "mksu/0001-50_add_susfs_to_kernelside_5ec1cff.patch"
            mksu_patches: "mksu/0001-10_enable_susfs_for_ksu_5ec1cff.patch"
            ak3_suffix: "_MKSU"
            extra_configs: |
              CONFIG_KSU_EXTRAS=y
              CONFIG_KSU_KRETPROBES_SUCOMPAT=y
              CONFIG_KSU_THRONE_TRACKER_ALWAYS_THREADED=y
          - type: KowSU
            name: "KowSU"
            ksu: true
            repo: "KOWX712/KernelSU"
            folder: "KernelSU"
            branch: "master"
            ksu_kernel_patches: "kowsu/0001-50_add_susfs_to_kernelside_KOWX712.patch"
            kowsu_patches: "kowsu/0001-10-add_SuSFS_to_KernelSU_KOWX712.patch"
            ak3_suffix: "_KowSU"
          - type: xxKSU
            name: "xxKSU"
            ksu: true
            repo: "backslashxx/KernelSU"
            folder: "KernelSU"
            branch: "master"
            kernel_patches: "sultan/scope-min-hooks-v1.6.patch"
            ak3_suffix: "_xxKSU"
            extra_configs: |
              CONFIG_KSU_EXTRAS=y
              CONFIG_KSU_KRETPROBES_SUCOMPAT=y
              CONFIG_KSU_THRONE_TRACKER_ALWAYS_THREADED=y
        susfs: [false, true]

    steps:
      - name: Download and extract GCC 14.2.0 toolchain
        run: |
          wget -q https://kernel.org/pub/tools/crosstool/files/bin/x86_64/14.2.0/x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz -O gcc.tar.gz
          gunzip gcc.tar.gz
          tar -xf gcc.tar

      - name: Clone Dependencies and Set ENV
        run: |
          ANYKERNEL_BRANCH="sultan-${{ matrix.kernel.codename }}"
          SUSFS_BRANCH="gki-${{ matrix.kernel.android_version }}-${{ matrix.kernel.kernel_version }}"

          sudo apt-get update && sudo apt-get install -y ccache
          ccache --max-size=2G
          ccache --set-config=compression=true
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

          git clone --depth=1 https://github.com/TheWildJames/AnyKernel3.git -b "$ANYKERNEL_BRANCH" AK3
          echo "ak3_dir=$PWD/AK3" >> $GITHUB_ENV

          git clone --depth=5 https://gitlab.com/simonpunk/susfs4ksu.git -b "$SUSFS_BRANCH" susfs
          echo "susfs_dir=$PWD/susfs" >> $GITHUB_ENV

          git clone --depth=1 https://github.com/TheSillyOk/sh sh
          echo "sh_dir=$PWD/sh" >> $GITHUB_ENV

          git clone --depth=1 https://github.com/TheSillyOk/kernel_ls_patches ok_patches
          echo "ok_dir=$PWD/ok_patches" >> $GITHUB_ENV

          git clone --depth=1 https://github.com/yapixel/kernel_patches yapixel_patches
          echo "yapixel_dir=$PWD/yapixel_patches" >> $GITHUB_ENV

          git clone --depth=1 https://github.com/kerneltoast/${{ matrix.kernel.repo }} sultan
          echo "kernel_dir=$PWD/sultan" >> $GITHUB_ENV

      - name: Apply Kernel & KSU Patches
        run: |
          cd "${{ env.kernel_dir }}"
          # Apply general kernel patches
          if [[ -n "${{ matrix.build.kernel_patches }}" ]]; then
            for p in ${{ matrix.build.kernel_patches }}; do
              patch -p1 < "${{ env.yapixel_dir }}/$p" || true
            done
          fi
          # Apply KSU variant patches if exists
          if [[ "${{ matrix.build.ksu }}" == "true" ]]; then
            cd "${{ env.kernel_dir }}/KernelSU"
            for patch_type in ksu_kernel_patches kowsu_patches mksu_patches; do
              PATCHES=${{ matrix.build[patch_type] }}
              if [[ -n "$PATCHES" ]]; then
                for p in $PATCHES; do
                  cp "${{ env.yapixel_dir }}/$p" ./
                  patch -p1 < "$(basename "$p")" || true
                  rm -f "$(basename "$p")"
                done
              fi
            done
          fi

      - name: Apply SUSFS patches for SukiSU/MKSU/KowSU
        if: matrix.susfs
        run: |
          cd "${{ env.kernel_dir }}"
          cp -r "${{ env.susfs_dir }}/kernel_patches/fs/"* fs/ 2>/dev/null || true
          cp -r "${{ env.susfs_dir }}/kernel_patches/include/linux/"* include/linux/ 2>/dev/null || true
          # Apply standard SukiSU SUSFS patch
          if [[ "${{ matrix.build.type }}" == "SukiSU" ]]; then
            cp "${{ env.susfs_dir }}/kernel_patches/50_add_susfs_in_gki-${{ matrix.kernel.android_version }}-${{ matrix.kernel.kernel_version }}.patch" .
            patch -p1 < "50_add_susfs_in_gki-${{ matrix.kernel.android_version }}-${{ matrix.kernel.kernel_version }}.patch" || true
            rm -f "50_add_susfs_in_gki-${{ matrix.kernel.android_version }}-${{ matrix.kernel.kernel_version }}.patch"
          fi

      - name: Setup Kernel Configs
        run: |
          cd "${{ env.kernel_dir }}"
          configs="CONFIG_TMPFS_XATTR=y CONFIG_TMPFS_POSIX_ACL=y CONFIG_IP_NF_TARGET_TTL=y CONFIG_IP6_NF_TARGET_HL=y CONFIG_IP6_NF_MATCH_HL=y CONFIG_TCP_CONG_ADVANCED=y CONFIG_TCP_CONG_BBR=y CONFIG_NET_SCH_FQ=y CONFIG_TCP_CONG_BIC=n CONFIG_TCP_CONG_WESTWOOD=n CONFIG_TCP_CONG_HTCP=n CONFIG_DEFAULT_BBR=y CONFIG_BPF_STREAM_PARSER=y CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y CONFIG_NETFILTER_XT_SET=y CONFIG_IP_SET=y CONFIG_IP_SET_MAX=65534 CONFIG_IP_SET_BITMAP_IP=y CONFIG_IP_SET_BITMAP_IPMAC=y CONFIG_IP_SET_BITMAP_PORT=y CONFIG_IP_SET_HASH_IP=y CONFIG_IP_SET_HASH_IPMARK=y CONFIG_IP_SET_HASH_IPPORT=y CONFIG_IP_SET_HASH_IPPORTIP=y CONFIG_IP_SET_HASH_IPPORTNET=y CONFIG_IP_SET_HASH_IPMAC=y CONFIG_IP_SET_HASH_MAC=y CONFIG_IP_SET_HASH_NETPORTNET=y CONFIG_IP_SET_HASH_NET=y CONFIG_IP_SET_HASH_NETNET=y CONFIG_IP_SET_HASH_NETPORT=y CONFIG_IP_SET_HASH_NETIFACE=y CONFIG_IP_SET_LIST_SET=y CONFIG_IP6_NF_NAT=y CONFIG_IP6_NF_TARGET_MASQUERADE=y CONFIG_KSU=y"
          echo '${{ matrix.build.extra_configs }}' | tr '|' '\n' >> temp_configs.txt
          while IFS= read -r line; do
            configs="$configs $line"
          done < temp_configs.txt
          rm -f temp_configs.txt
          if [[ "${{ matrix.susfs }}" == "true" ]]; then
            configs="$configs CONFIG_SUSFS=y CONFIG_KSU_SUSFS=y CONFIG_KSU_SUSFS_SUS_PATH=y CONFIG_KSU_SUSFS_SUS_MOUNT=y CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y CONFIG_KSU_SUSFS_SPOOF_UNAME=y CONFIG_KSU_SUSFS_ENABLE_LOG=y CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y"
          fi
          for config in $configs; do
            name=$(echo "$config" | cut -d'=' -f1)
            sed -i -E "s/.*($name=.*)/# \1 is not set/gi" arch/arm64/configs/${{ matrix.kernel.defconfig }}
            echo "$config" >> arch/arm64/configs/${{ matrix.kernel.defconfig }}
          done
          sed -i 's/${LOCALVERSION+set}/set/' scripts/setlocalversion
          sed -i 's/CONFIG_LOCALVERSION="-Sultan"/CONFIG_LOCALVERSION="${{ matrix.kernel.local_version }}"/' arch/arm64/configs/${{ matrix.kernel.defconfig }}
          perl -pi -e 's/build-timestamp = \$\(or \$\(KBUILD_BUILD_TIMESTAMP\), \$\(build-timestamp-auto\)\)/build-timestamp = "${{ matrix.kernel.build_date }}"/' init/Makefile

      - name: Cache Kernel Build
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: sultan-${{ matrix.kernel.codename }}-${{ matrix.build.type }}-susfs${{ matrix.susfs }}-ccache-${{ github.sha }}
          restore-keys: |
            sultan-${{ matrix.kernel.codename }}-${{ matrix.build.type }}-susfs${{ matrix.susfs }}-ccache-

      - name: Build Kernel
        run: |
          cd "${{ env.kernel_dir }}"
          export KBUILD_BUILD_USER="build-user"
          export KBUILD_BUILD_HOST="build-host"
          make O=out CROSS_COMPILE=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux- CC=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-gcc ${{ matrix.kernel.defconfig }}
          make O=out CROSS_COMPILE="ccache $GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-" CC="ccache $GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-gcc" -j$(nproc --all)

      - name: Package AnyKernel3
        run: |
          cp "${{ env.kernel_dir }}/out/arch/arm64/boot/Image.lz4" "${{ env.ak3_dir }}/Image.lz4"
          cat "${{ env.kernel_dir }}/out/google-devices/${{ matrix.kernel.codename }}/dts/"*.dtb \
              > "${{ env.ak3_dir }}/dtb"
          cd "${{ env.ak3_dir }}"
          zip -r9 "${GITHUB_WORKSPACE}/${{ matrix.build.type }}${{ matrix.susfs && '-SUSFS' || '' }}.zip" . -x "*.git*" "README.md" "placeholder"
          echo "ZIP_FULLPATH=${GITHUB_WORKSPACE}/${{ matrix.build.type }}${{ matrix.susfs && '-SUSFS' || '' }}.zip" >> "$GITHUB_ENV"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ matrix.build.type }}${{ matrix.susfs && '-SUSFS' || '' }}
          path: |
            ${{ env.ZIP_FULLPATH }}
            ${{ env.ZIP_FULLPATH }}.sha256

      - name: Create Daily Release Tag
        id: tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE_TAG=$(date +"%Y/%m/%d")
          LATEST=$(gh api "repos/${{ github.repository }}/tags" --jq '.[0].name' 2>/dev/null || echo "")
          if [[ -n "$LATEST" && "$LATEST" == "$BASE_TAG"* ]]; then
            REV=$(echo "$LATEST" | grep -o 'r[0-9]*$' | sed 's/^r//' || echo "0")
            REV=$((REV + 1))
            TAG="${BASE_TAG}-r${REV}"
          else
            TAG="${BASE_TAG}-r1"
          fi
          gh api -X DELETE "/repos/${{ github.repository }}/git/refs/tags/$TAG" > /dev/null 2>&1 || true
          gh api -X POST "/repos/${{ github.repository }}/git/refs" -f ref="refs/tags/$TAG" -f sha="${{ github.sha }}" || exit 1
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV
lversion
          sed -i "s/CONFIG_LOCALVERSION=\"-Sultan\"/CONFIG_LOCALVERSION=\"${{ matrix.kernel.local_version }}\"/" arch/arm64/configs/${{ matrix.kernel.defconfig }}
          perl -pi -e "s/build-timestamp = .*/build-timestamp = \"${{ matrix.kernel.build_date }}\"/" init/Makefile

      - name: Cache Kernel Build
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: sultan-${{ matrix.kernel.codename }}-${{ matrix.build.type }}-susfs${{ matrix.susfs }}-${{ github.sha }}
          restore-keys: |
            sultan-${{ matrix.kernel.codename }}-${{ matrix.build.type }}-susfs${{ matrix.susfs }}-

      - name: Build Kernel
        run: |
          cd "${{ env.kernel_dir }}"
          export KBUILD_BUILD_USER="build-user"
          export KBUILD_BUILD_HOST="build-host"
          make O=out CROSS_COMPILE=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux- CC=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-gcc ${{ matrix.kernel.defconfig }}
          make O=out CROSS_COMPILE="ccache $GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-" CC="ccache $GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-gcc" -j$(nproc --all)

      ##################################################################
      #                  ðŸ”¥ SukiSU KernelPatch (KPM)                    #
      ##################################################################
      - name: Apply SukiSU KernelPatch (KPM)
        if: matrix.build.type == 'SukiSU'
        run: |
          echo "=== Applying KernelPatch (KPM) for SukiSU ==="

          cd "$GITHUB_WORKSPACE"

          git clone --depth=1 https://github.com/ShirkNeko/SukiSU_KernelPatch_patch kernelpatch
          cd kernelpatch

          IN_KERNEL="${{ env.kernel_dir }}/out/arch/arm64/boot/Image.lz4"
          OUT_KERNEL="Image_patched.lz4"

          python3 kernel_patch.py "$IN_KERNEL" "$OUT_KERNEL"
          cp "$OUT_KERNEL" "$GITHUB_WORKSPACE/Image.lz4"

      - name: Package AnyKernel3
        run: |
          if [[ "${{ matrix.build.type }}" == "SukiSU" ]]; then
            cp "$GITHUB_WORKSPACE/Image.lz4" "${{ env.ak3_dir }}/Image.lz4"
          else
            cp "${{ env.kernel_dir }}/out/arch/arm64/boot/Image.lz4" "${{ env.ak3_dir }}/Image.lz4"
          fi

          cat "${{ env.kernel_dir }}/out/google-devices/${{ matrix.kernel.codename }}/dts/"*.dtb \
              > "${{ env.ak3_dir }}/dtb"

          cd "${{ env.ak3_dir }}"
          zip -r9 "${GITHUB_WORKSPACE}/${{ env.ZIP_NAME }}" . -x "*.git*" "README.md" "placeholder"

          cd "${GITHUB_WORKSPACE}"
          sha256sum "${{ env.ZIP_NAME }}" > "${{ env.ZIP_NAME }}.sha256"
          echo "ZIP_FULLPATH=${GITHUB_WORKSPACE}/${{ env.ZIP_NAME }}" >> "$GITHUB_ENV"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ matrix.build.type }}${{ matrix.susfs && '-SUSFS' || '' }}
          path: |
            ${{ env.ZIP_FULLPATH }}
            ${{ env.ZIP_FULLPATH }}.sha256

      - name: Create Daily Release Tag
        id: tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE_TAG=$(date +"%Y/%m/%d")
          LATEST=$(gh api "repos/${{ github.repository }}/tags" --jq '.[0].name' 2>/dev/null || echo "")

          if [[ -n "$LATEST" && "$LATEST" == "$BASE_TAG"* ]]; then
            REV=$(echo "$LATEST" | grep -o 'r[0-9]*$' | sed 's/^r//' || echo "0")
            REV=$((REV + 1))
            TAG="${BASE_TAG}-r${REV}"
          else
            TAG="${BASE_TAG}-r1"
          fi

          gh api -X DELETE "/repos/${{ github.repository }}/git/refs/tags/$TAG" > /dev/null 2>&1 || true
          gh api -X POST "/repos/${{ github.repository }}/git/refs" \
            -f ref="refs/tags/$TAG" \
            -f sha="${{ github.sha }}"

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV

  release:
    needs: build
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Set Release Info
        run: |
          echo "date=$(date +"%d/%m/%Y")" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.release_tag }}
          name: Sultan Kernel - ${{ env.date }}
          files: ./artifacts/**/*.zip
          fail_on_unmatched_files: true
arch/arm64/configs/${{ matrix.kernel.defconfig }}

      #########################################################################
      # Cache
      #########################################################################
      - uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: build-${{ matrix.build.type }}-${{ matrix.susfs }}

      #########################################################################
      # Build Kernel
      #########################################################################
      - name: Build kernel
        run: |
          cd "$kernel_dir"

          make O=out \
            CROSS_COMPILE=$GITHUB_WORKSPACE/x86_64-gcc-14.2.0-nolibc-aarch64-linux/bin/aarch64-linux- \
            ${{ matrix.kernel.defconfig }}

          make -j$(nproc) O=out \
            CROSS_COMPILE="ccache $GITHUB_WORKSPACE/x86_64-gcc-14.2.0-nolibc-aarch64-linux/bin/aarch64-linux-"

      #########################################################################
      # â­ Apply KernelPatch (KPM Support for SukiSU)
      #########################################################################
      - name: Apply SukiSU KernelPatch (KPM)
        if: matrix.build.type == 'SukiSU'
        run: |
          echo "=== Applying KernelPatch KPM for SukiSU ==="

          cd "$GITHUB_WORKSPACE"

          # Clone SukiSU KernelPatch
          git clone --depth=1 https://github.com/ShirkNeko/SukiSU_KernelPatch_patch kernelpatch
          cd kernelpatch

          IN_KERNEL="${{ env.kernel_dir }}/out/arch/arm64/boot/Image.lz4"
          OUT_KERNEL="Image_patched.lz4"

          python3 kernel_patch.py "$IN_KERNEL" "$OUT_KERNEL"

          echo "KernelPatch applied successfully!"

          cp "$OUT_KERNEL" "$GITHUB_WORKSPACE/Image.lz4"

      #########################################################################
      # Package into AnyKernel3
      #########################################################################
      - name: Package AK3
        run: |
          # SukiSU uses patched kernel
          if [[ "${{ matrix.build.type }}" == "SukiSU" ]]; then
            cp "$GITHUB_WORKSPACE/Image.lz4" "$ak3_dir/Image.lz4"
          else
            cp "$kernel_dir/out/arch/arm64/boot/Image.lz4" "$ak3_dir/Image.lz4"
          fi

          cat "$kernel_dir/out/google-devices/${{ matrix.kernel.codename }}/dts/"*.dtb \
            > "$ak3_dir/dtb"

          cd "$ak3_dir"

          ZIP_NAME="Sultan-${{ matrix.kernel.kernel_version }}.${{ matrix.kernel.sub_level }}-${{ matrix.build.type }}${{ matrix.susfs && '-SUSFS' || '' }}.zip"

          zip -r9 "$GITHUB_WORKSPACE/$ZIP_NAME" .

      #########################################################################
      # Upload artifacts
      #########################################################################
      - uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ matrix.build.type }}${{ matrix.susfs && '-SUSFS' || '' }}
          path: "Sultan-*.zip"

      #########################################################################
      # Tag
      #########################################################################
      - name: Create Daily Release Tag
        id: tag
        run: |
          TAG=$(date +"%Y/%m/%d")-r1
          echo "tag=$TAG" >> $GITHUB_OUTPUT

  #############################################################################
  # RELEASE JOB
  #############################################################################
  release:
    needs: build
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Generate release notes
        run: |
          cat <<EOF > release_body.md
          ## Sultan Kernel Release â€” $(date +"%Y-%m-%d")

          #### Included Variants:
          Auto-generated from build matrix.

          #### Features:
          - SukiSU / MKSU / KowSU / xxKSU builds
          - Full KPM support for SukiSU
          - SUSFS when applicable

          EOF

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.release_tag }}
          body_path: release_body.md
          files: ./artifacts/**/*.zip
