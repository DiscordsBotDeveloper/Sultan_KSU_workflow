name: Sultan Test

permissions:
  contents: write
  actions: write

on:
  workflow_call:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

jobs:
  build:
    runs-on: ubuntu-latest

    if: >
      ${{ github.event_name != 'pull_request'
          || contains(github.event.pull_request.labels.*.name, 'build') }}

    name: Sultan-${{ matrix.build.type }}${{ matrix.susfs && '_SUSFS' || '' }}

    outputs:
      release_tag: ${{ steps.tag.outputs.tag }}

    strategy:
      fail-fast: false
      matrix:

        #######################################################################
        # KERNEL TARGET
        #######################################################################
        kernel:
          - codename: gs201
            repo: android_kernel_google_gs201
            android_version: android14
            kernel_version: "6.1"
            sub_level: "134"
            defconfig: gs201_defconfig
            local_version: "-android14-11-g66e758f7d0c0-ab13748739"
            build_date: "Tue Jul 8 09:17:32 UTC 2025"

        #######################################################################
        # BUILD TARGETS (VARIANTS)
        #######################################################################
        build:
          - { type: SukiSU, name: SukiSU, ksu: true,
              repo: "SukiSU-Ultra/SukiSU-Ultra", folder: KernelSU, branch: main,
              susfs_repo: "SukiSU-Ultra/SukiSU-Ultra", susfs_branch: susfs-main,
              kernel_patches: "sultan/scope-min-hooks-v1.6.patch",
              extra_configs: |
                CONFIG_KPM=y
                CONFIG_KALLSYMS=y
                CONFIG_KALLSYMS_ALL=y
                CONFIG_KSU_SUSFS=y
                CONFIG_KSU_MANUAL_SU=n
                CONFIG_COMPAT=y
                CONFIG_ZRAM_GS_WRITEBACK=y,
              ak3_suffix: "_SukiSU"
            }

          - { type: MKSU, name: MKSU, ksu: true,
              repo: "5ec1cff/KernelSU", folder: KernelSU, branch: main,
              ksu_kernel_patches: "mksu/0001-50_add_susfs_to_kernelside_5ec1cff.patch",
              mksu_patches: "mksu/0001-10_enable_susfs_for_ksu_5ec1cff.patch",
              extra_configs: |
                CONFIG_KSU_EXTRAS=y
                CONFIG_KSU_KRETPROBES_SUCOMPAT=y
                CONFIG_KSU_THRONE_TRACKER_ALWAYS_THREADED=y,
              ak3_suffix: "_MKSU"
            }

          - { type: KowSU, name: KowSU, ksu: true,
              repo: "KOWX712/KernelSU", folder: KernelSU, branch: master,
              ksu_kernel_patches: "kowsu/0001-50_add_susfs_to_kernelside_KOWX712.patch",
              kowsu_patches: "kowsu/0001-10-add_SuSFS_to_KernelSU_KOWX712.patch",
              ak3_suffix: "_KowSU"
            }

          - { type: xxKSU, name: xxKSU, ksu: true,
              repo: "backslashxx/KernelSU", folder: KernelSU, branch: master,
              kernel_patches: "sultan/scope-min-hooks-v1.6.patch",
              extra_configs: |
                CONFIG_KSU_EXTRAS=y
                CONFIG_KSU_KRETPROBES_SUCOMPAT=y
                CONFIG_KSU_THRONE_TRACKER_ALWAYS_THREADED=y,
              ak3_suffix: "_xxKSU"
            }

        #######################################################################
        # SUSFS
        #######################################################################
        susfs: [false, true]

        # Exclusions
        exclude:
          - { build: { type: SukiSU }, susfs: false }
          - { build: { type: MKSU }, susfs: true }
          - { build: { type: KowSU }, susfs: false }
          - { build: { type: xxKSU }, susfs: true }

    ###########################################################################
    # STEPS
    ###########################################################################
    steps:

      #########################################################################
      # Toolchain
      #########################################################################
      - name: Download GCC 14.2.0
        run: |
          wget -q https://kernel.org/pub/tools/crosstool/files/bin/x86_64/14.2.0/x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz -O gcc.tar.gz
          tar -xzf gcc.tar.gz

      #########################################################################
      # Clone dependencies
      #########################################################################
      - name: Clone repositories
        run: |
          ANYKERNEL_BRANCH="sultan-${{ matrix.kernel.codename }}"
          SUSFS_BRANCH="gki-${{ matrix.kernel.android_version }}-${{ matrix.kernel.kernel_version }}"

          sudo apt-get update && sudo apt-get install -y ccache python3 python3-pip
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          ccache --max-size=2G --set-config=compression=true

          git clone --depth=1 https://github.com/TheWildJames/AnyKernel3.git -b "$ANYKERNEL_BRANCH" AK3
          git clone --depth=5 https://gitlab.com/simonpunk/susfs4ksu.git -b "$SUSFS_BRANCH" susfs
          git clone --depth=1 https://github.com/TheWildJames/kernel_patches.git james_patches
          git clone --depth=1 https://github.com/TheSillyOk/kernel_ls_patches ok_patches
          git clone --depth=1 https://github.com/yapixel/kernel_patches yapixel_patches
          git clone --depth=1 https://github.com/kerneltoast/${{ matrix.kernel.repo }} sultan
          git clone --depth=1 https://github.com/TheSillyOk/sh sh

          echo "kernel_dir=$PWD/sultan" >> $GITHUB_ENV
          echo "ak3_dir=$PWD/AK3" >> $GITHUB_ENV
          echo "susfs_dir=$PWD/susfs" >> $GITHUB_ENV
          echo "james_dir=$PWD/james_patches" >> $GITHUB_ENV
          echo "ok_dir=$PWD/ok_patches" >> $GITHUB_ENV
          echo "yapixel_dir=$PWD/yapixel_patches" >> $GITHUB_ENV
          echo "sh_dir=$PWD/sh" >> $GITHUB_ENV

      #########################################################################
      # Detect KSU version
      #########################################################################
      - name: Detect KSU version
        id: ksu
        run: |
          V="${{ matrix.build.type }}"
          KSU_VER="unknown"

          case "$V" in
            "SukiSU") KSU_VER=$(./sh/extract_ksuver.sh "https://github.com/SukiSU-Ultra/SukiSU-Ultra" kernel/Makefile . susfs-main) ;;
            "xxKSU")  KSU_VER=$(./sh/extract_ksuver.sh "https://github.com/backslashxx/KernelSU" kernel/Makefile . master) ;;
            "KowSU")  KSU_VER=$(./sh/get_ksuver.sh KOWX712 KernelSU master) ;;
            "MKSU")   KSU_VER=$(./sh/get_ksuver.sh 5ec1cff KernelSU main) ;;
          esac

          echo "KSU_VER=$KSU_VER" >> $GITHUB_ENV

      #########################################################################
      # Apply kernel patches (unified)
      #########################################################################
      - name: Apply kernel patches
        run: |
          cd "$kernel_dir"

          APPLY() {
            [ -z "$1" ] && return
            if [ -f "$2/$1" ]; then
              cp "$2/$1" tmp.patch
              patch --fuzz=5 -p1 < tmp.patch || true
              rm tmp.patch
            fi
          }

          for p in ${{ matrix.build.kernel_patches }}; do
            APPLY "$p" "$ok_dir"
          done

          for p in ${{ matrix.build.ksu_kernel_patches }}; do
            APPLY "$p" "$yapixel_dir"
          done

      #########################################################################
      # Install KernelSU
      #########################################################################
      - name: Install KernelSU
        if: matrix.build.ksu
        run: |
          cd "$kernel_dir"

          REPO="${{ matrix.build.susfs_repo || matrix.build.repo }}"
          BRANCH="${{ matrix.build.susfs_branch || matrix.build.branch }}"

          curl -fsSL "https://raw.githubusercontent.com/$REPO/$BRANCH/kernel/setup.sh" \
            | bash -s -- "$BRANCH"

      #########################################################################
      # Apply SUSFS
      #########################################################################
      - name: Apply SUSFS patches
        if: matrix.susfs
        run: |
          cd "$kernel_dir"

          cp -r "$susfs_dir/kernel_patches/fs/"* fs/ 2>/dev/null || true
          cp -r "$susfs_dir/kernel_patches/include/linux/"* include/linux/ 2>/dev/null || true

          if [[ "${{ matrix.build.type }}" == "SukiSU" ]]; then
            cp "$susfs_dir/kernel_patches/50_add_susfs_in_gki-${{ matrix.kernel.android_version }}-${{ matrix.kernel.kernel_version }}.patch" tmp.patch
            patch -p1 < tmp.patch || true
            rm tmp.patch
          fi

      #########################################################################
      # Apply final fix patch
      #########################################################################
      - name: Apply sys.c fix
        run: |
          cd "$kernel_dir"
          patch --fuzz=3 -p1 < "$james_dir/sultan/sys.c_fix.patch" || true

      #########################################################################
      # Generate configs
      #########################################################################
      - name: Generate configs
        run: |
          cd "$kernel_dir"

          BASE="
          CONFIG_TMPFS_XATTR=y CONFIG_TMPFS_POSIX_ACL=y
          CONFIG_IP6_NF_TARGET_MASQUERADE=y
          CONFIG_KSU=y
          "

          EXTRA=$(printf "%s" "${{ matrix.build.extra_configs }}")

          if [[ "${{ matrix.susfs }}" == "true" ]]; then
            EXTRA="$EXTRA
            CONFIG_SUSFS=y
            CONFIG_KSU_SUSFS=y
            CONFIG_KSU_SUSFS_SUS_PATH=y
            CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
            "
          fi

          for C in $BASE $EXTRA; do
            NAME=$(echo "$C" | cut -d= -f1)
            sed -i "/^$NAME=/d" arch/arm64/configs/${{ matrix.kernel.defconfig }}
            echo "$C" >> arch/arm64/configs/${{ matrix.kernel.defconfig }}
          done

      #########################################################################
      # Cache
      #########################################################################
      - uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: build-${{ matrix.build.type }}-${{ matrix.susfs }}

      #########################################################################
      # Build Kernel
      #########################################################################
      - name: Build kernel
        run: |
          cd "$kernel_dir"

          make O=out \
            CROSS_COMPILE=$GITHUB_WORKSPACE/x86_64-gcc-14.2.0-nolibc-aarch64-linux/bin/aarch64-linux- \
            ${{ matrix.kernel.defconfig }}

          make -j$(nproc) O=out \
            CROSS_COMPILE="ccache $GITHUB_WORKSPACE/x86_64-gcc-14.2.0-nolibc-aarch64-linux/bin/aarch64-linux-"

      #########################################################################
      # ⭐ Apply KernelPatch (KPM Support for SukiSU)
      #########################################################################
      - name: Apply SukiSU KernelPatch (KPM)
        if: matrix.build.type == 'SukiSU'
        run: |
          echo "=== Applying KernelPatch KPM for SukiSU ==="

          cd "$GITHUB_WORKSPACE"

          # Clone SukiSU KernelPatch
          git clone --depth=1 https://github.com/ShirkNeko/SukiSU_KernelPatch_patch kernelpatch
          cd kernelpatch

          IN_KERNEL="${{ env.kernel_dir }}/out/arch/arm64/boot/Image.lz4"
          OUT_KERNEL="Image_patched.lz4"

          python3 kernel_patch.py "$IN_KERNEL" "$OUT_KERNEL"

          echo "KernelPatch applied successfully!"

          cp "$OUT_KERNEL" "$GITHUB_WORKSPACE/Image.lz4"

      #########################################################################
      # Package into AnyKernel3
      #########################################################################
      - name: Package AK3
        run: |
          # SukiSU uses patched kernel
          if [[ "${{ matrix.build.type }}" == "SukiSU" ]]; then
            cp "$GITHUB_WORKSPACE/Image.lz4" "$ak3_dir/Image.lz4"
          else
            cp "$kernel_dir/out/arch/arm64/boot/Image.lz4" "$ak3_dir/Image.lz4"
          fi

          cat "$kernel_dir/out/google-devices/${{ matrix.kernel.codename }}/dts/"*.dtb \
            > "$ak3_dir/dtb"

          cd "$ak3_dir"

          ZIP_NAME="Sultan-${{ matrix.kernel.kernel_version }}.${{ matrix.kernel.sub_level }}-${{ matrix.build.type }}${{ matrix.susfs && '-SUSFS' || '' }}.zip"

          zip -r9 "$GITHUB_WORKSPACE/$ZIP_NAME" .

      #########################################################################
      # Upload artifacts
      #########################################################################
      - uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ matrix.build.type }}${{ matrix.susfs && '-SUSFS' || '' }}
          path: "Sultan-*.zip"

      #########################################################################
      # Tag
      #########################################################################
      - name: Create Daily Release Tag
        id: tag
        run: |
          TAG=$(date +"%Y/%m/%d")-r1
          echo "tag=$TAG" >> $GITHUB_OUTPUT

  #############################################################################
  # RELEASE JOB
  #############################################################################
  release:
    needs: build
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Generate release notes
        run: |
          cat <<EOF > release_body.md
          ## Sultan Kernel Release — $(date +"%Y-%m-%d")

          #### Included Variants:
          Auto-generated from build matrix.

          #### Features:
          - SukiSU / MKSU / KowSU / xxKSU builds
          - Full KPM support for SukiSU
          - SUSFS when applicable

          EOF

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.release_tag }}
          body_path: release_body.md
          files: ./artifacts/**/*.zip
